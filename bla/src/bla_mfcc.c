#include <bla_config.h>
#include <bla_mfcc.h>
#include <math.h>
#include <arm_math.h>
#include <arm_const_structs.h>

/*Pesos e índices del banco de filtros "semi triangulares" que usa el HTK
  fueron generados usando un snippet de código disponible acá: https://github.com/danijel3/PyHTK*/
static const int blaBancoFiltrosIdx[256] = {-1, 0, 0, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 4, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7, 7, 8, 8, 8, 8, 8, 9, 9, 9, 9, 9, 10, 10, 10, 10, 10, 10, 11, 11, 11, 11, 11, 11, 12, 12, 12, 12, 12, 12, 13, 13, 13, 13, 13, 13, 13, 13, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26};

static const float blaBancoFiltrosPesos[256]  = {0, 0.532053, 0.083690, 0.653340, 0.239609, 0.841262, 0.457196, 0.086422, 0.728051, 0.381280, 0.045381, 0.719694, 0.403615, 0.096594, 0.798127, 0.507748, 0.225033, 0.949586, 0.681043, 0.419067, 0.163344, 0.913582, 0.669510, 0.430874, 0.197439, 0.968980, 0.745291, 0.526177, 0.311455, 0.100951, 0.894504, 0.691959, 0.493172, 0.298007, 0.106333, 0.918027, 0.732974, 0.551064, 0.372190, 0.196254, 0.023160, 0.852818, 0.685141, 0.520049, 0.357461, 0.197305, 0.039506, 0.883999, 0.730716, 0.579595, 0.430576, 0.283601, 0.138615, 0.995566, 0.854400, 0.715071, 0.577529, 0.441732, 0.307633, 0.175193, 0.044370, 0.915125, 0.787420, 0.661220, 0.536488, 0.413192, 0.291299, 0.170777, 0.051596, 0.933725, 0.817138, 0.701805, 0.587701, 0.474799, 0.363075, 0.252503, 0.143061, 0.034725, 0.927474, 0.821286, 0.716140, 0.612015, 0.508894, 0.406755, 0.305580, 0.205353, 0.106053, 0.007666, 0.910174, 0.813561, 0.717812, 0.622911, 0.528842, 0.435593, 0.343147, 0.251494, 0.160617, 0.070505, 0.981144, 0.892523, 0.804628, 0.717448, 0.630972, 0.545190, 0.460087, 0.375655, 0.291885, 0.208763, 0.126282, 0.044430, 0.963200, 0.882580, 0.802562, 0.723138, 0.644298, 0.566034, 0.488337, 0.411200, 0.334615, 0.258572, 0.183066, 0.108088, 0.033632, 0.959688, 0.886251, 0.813315, 0.740874, 0.668915, 0.597439, 0.526437, 0.455901, 0.385826, 0.316207, 0.247038, 0.178313, 0.110026, 0.042171, 0.974743, 0.907735, 0.841145, 0.774968, 0.709195, 0.643823, 0.578849, 0.514266, 0.450071, 0.386257, 0.322821, 0.259759, 0.197066, 0.134738, 0.072769, 0.011157, 0.949896, 0.888985, 0.828418, 0.768192, 0.708300, 0.648745, 0.589517, 0.530614, 0.472034, 0.413772, 0.355825, 0.298191, 0.240864, 0.183841, 0.127123, 0.070703, 0.014576, 0.958744, 0.903202, 0.847943, 0.792969, 0.738276, 0.683862, 0.629722, 0.575853, 0.522256, 0.468924, 0.415856, 0.363050, 0.310504, 0.258214, 0.206177, 0.154392, 0.102856, 0.051566, 0.000522, 0.949720, 0.899156, 0.848829, 0.798739, 0.748884, 0.699255, 0.649859, 0.600688, 0.551743, 0.503017, 0.454515, 0.406231, 0.358162, 0.310310, 0.262670, 0.215240, 0.168019, 0.121007, 0.074199, 0.027595, 0.981193, 0.934991, 0.888986, 0.843178, 0.797568, 0.752147, 0.706920, 0.661883, 0.617036, 0.572373, 0.527897, 0.483605, 0.439497, 0.395567, 0.351818, 0.308245, 0.264849, 0.221630, 0.178584, 0.135710, 0.093006, 0.050471, 0.008105, 0.965906, 0.923873, 0.882004, 0.840297, 0.798753, 0.757369, 0.716146, 0.675077, 0.634169, 0.593414, 0.552815, 0.512366, 0.472073, 0.431929, 0.391935, 0.352090, 0.312394, 0.272844, 0.233437, 0.194177, 0.155058, 0.116084, 0.077248, 0.038555};

/*Ventana de Hamming usada con cada bloque - Generada con el código que está en test/bla_gen_hamming */
static const float blaHamming[BLA_LARGOVENTANA] = {0.08,0.080057,0.0802281,0.0805132,0.0809123,0.0814252,0.0820517,0.0827919,0.0836454,0.0846121,0.0856917,0.086884,0.0881886,0.0896053,0.0911337,0.0927733,0.0945239,0.0963849,0.098356,0.100437,0.102626,0.104924,0.10733,0.109843,0.112463,0.115189,0.11802,0.120956,0.123996,0.127139,0.130384,0.133731,0.137178,0.140726,0.144372,0.148117,0.151959,0.155897,0.15993,0.164058,0.168278,0.172591,0.176995,0.181489,0.186072,0.190743,0.1955,0.200343,0.20527,0.21028,0.215372,0.220544,0.225795,0.231125,0.236531,0.242012,0.247567,0.253195,0.258893,0.264662,0.270499,0.276402,0.282371,0.288404,0.294499,0.300655,0.306871,0.313144,0.319473,0.325857,0.332295,0.338783,0.345322,0.351909,0.358543,0.365221,0.371943,0.378707,0.38551,0.392352,0.399231,0.406144,0.413091,0.420069,0.427077,0.434113,0.441175,0.448261,0.455371,0.462501,0.46965,0.476817,0.484,0.491197,0.498405,0.505624,0.512852,0.520086,0.527325,0.534567,0.541811,0.549054,0.556295,0.563532,0.570763,0.577987,0.585201,0.592403,0.599593,0.606768,0.613927,0.621067,0.628187,0.635285,0.64236,0.649409,0.656431,0.663424,0.670387,0.677317,0.684213,0.691073,0.697896,0.70468,0.711423,0.718124,0.72478,0.73139,0.737953,0.744467,0.75093,0.757341,0.763699,0.77,0.776245,0.78243,0.788556,0.79462,0.800621,0.806558,0.812428,0.818231,0.823965,0.829628,0.83522,0.840738,0.846182,0.85155,0.85684,0.862052,0.867184,0.872235,0.877204,0.882089,0.886889,0.891603,0.89623,0.900769,0.905218,0.909577,0.913844,0.918018,0.922098,0.926084,0.929974,0.933767,0.937463,0.94106,0.944558,0.947955,0.951251,0.954446,0.957537,0.960525,0.963409,0.966187,0.96886,0.971427,0.973886,0.976238,0.978482,0.980617,0.982643,0.984559,0.986365,0.98806,0.989644,0.991117,0.992478,0.993726,0.994862,0.995885,0.996796,0.997592,0.998276,0.998846,0.999302,0.999644,0.999872,0.999986,0.999986,0.999872,0.999644,0.999302,0.998846,0.998276,0.997592,0.996796,0.995885,0.994862,0.993726,0.992478,0.991117,0.989644,0.98806,0.986365,0.984559,0.982643,0.980617,0.978482,0.976238,0.973886,0.971427,0.96886,0.966187,0.963409,0.960525,0.957537,0.954446,0.951251,0.947955,0.944558,0.94106,0.937463,0.933767,0.929974,0.926084,0.922098,0.918018,0.913844,0.909577,0.905218,0.900769,0.89623,0.891603,0.886889,0.882089,0.877204,0.872235,0.867184,0.862052,0.85684,0.85155,0.846182,0.840738,0.83522,0.829628,0.823965,0.818231,0.812428,0.806558,0.800622,0.79462,0.788556,0.78243,0.776245,0.77,0.763699,0.757341,0.750931,0.744467,0.737953,0.73139,0.72478,0.718124,0.711423,0.70468,0.697896,0.691074,0.684213,0.677317,0.670387,0.663424,0.656431,0.649409,0.64236,0.635285,0.628187,0.621067,0.613927,0.606768,0.599593,0.592403,0.5852,0.577987,0.570763,0.563532,0.556295,0.549054,0.541811,0.534567,0.527325,0.520086,0.512852,0.505624,0.498405,0.491197,0.484,0.476817,0.46965,0.462501,0.455371,0.448261,0.441174,0.434113,0.427077,0.420069,0.413091,0.406144,0.399231,0.392352,0.38551,0.378707,0.371943,0.365221,0.358543,0.351909,0.345322,0.338783,0.332295,0.325857,0.319473,0.313144,0.306871,0.300655,0.294499,0.288404,0.282371,0.276402,0.270499,0.264662,0.258893,0.253195,0.247567,0.242012,0.236531,0.231125,0.225795,0.220544,0.215372,0.21028,0.20527,0.200343,0.1955,0.190743,0.186072,0.181489,0.176995,0.172591,0.168278,0.164058,0.15993,0.155897,0.151959,0.148117,0.144372,0.140726,0.137178,0.133731,0.130384,0.127139,0.123996,0.120956,0.11802,0.115189,0.112463,0.109843,0.10733,0.104924,0.102626,0.100437,0.098356,0.096385,0.0945239,0.0927734,0.0911337,0.0896053,0.0881887,0.086884,0.0856917,0.0846121,0.0836454,0.0827919,0.0820518,0.0814252,0.0809123,0.0805132,0.0802281,0.080057,0.08};

static const float blaDCT[BLA_NUMCEPS][BLA_NUMCHANS] = {{0.276844,0.272807,0.264792,0.252916,0.237351,0.218325,0.196116,0.171047,0.143484,0.113828,0.0825125,0.0499938,0.016746,-0.016746,-0.0499938,-0.0825125,-0.113828,-0.143484,-0.171047,-0.196116,-0.218325,-0.237351,-0.252916,-0.264792,-0.272807,-0.276844}
,{0.275328,0.259327,0.228255,0.183917,0.128891,0.0663742,1.69822e-017,-0.0663742,-0.128891,-0.183917,-0.228255,-0.259327,-0.275328,-0.275328,-0.259327,-0.228255,-0.183917,-0.128891,-0.0663742,-5.09467e-017,0.0663742,0.128891,0.183917,0.228255,0.259327,0.275328}
,{0.272807,0.237351,0.171047,0.0825125,-0.016746,-0.113828,-0.196116,-0.252916,-0.276844,-0.264792,-0.218325,-0.143484,-0.0499938,0.0499938,0.143484,0.218325,0.264792,0.276844,0.252916,0.196116,0.113828,0.016746,-0.0825125,-0.171047,-0.237351,-0.272807}
,{0.269291,0.2076,0.0983497,-0.0334309,-0.157553,-0.245581,-0.27735,-0.245581,-0.157553,-0.0334309,0.0983497,0.2076,0.269291,0.269291,0.2076,0.0983497,-0.0334309,-0.157553,-0.245581,-0.27735,-0.245581,-0.157553,-0.0334309,0.0983497,0.2076,0.269291}
,{0.264792,0.171047,0.016746,-0.143484,-0.252916,-0.272807,-0.196116,-0.0499938,0.113828,0.237351,0.276844,0.218325,0.0825125,-0.0825125,-0.218325,-0.276844,-0.237351,-0.113828,0.0499938,0.196116,0.272807,0.252916,0.143484,-0.016746,-0.171047,-0.264792}
,{0.259327,0.128891,-0.0663742,-0.228255,-0.275328,-0.183917,-5.09467e-017,0.183917,0.275328,0.228255,0.0663742,-0.128891,-0.259327,-0.259327,-0.128891,0.0663742,0.228255,0.275328,0.183917,-3.39833e-016,-0.183917,-0.275328,-0.228255,-0.0663742,0.128891,0.259327}
,{0.252916,0.0825125,-0.143484,-0.272807,-0.218325,-0.016746,0.196116,0.276844,0.171047,-0.0499938,-0.237351,-0.264792,-0.113828,0.113828,0.264792,0.237351,0.0499938,-0.171047,-0.276844,-0.196116,0.016746,0.218325,0.272807,0.143484,-0.0825125,-0.252916}
,{0.245581,0.0334309,-0.2076,-0.269291,-0.0983497,0.157553,0.27735,0.157553,-0.0983497,-0.269291,-0.2076,0.0334309,0.245581,0.245581,0.0334309,-0.2076,-0.269291,-0.0983497,0.157553,0.27735,0.157553,-0.0983497,-0.269291,-0.2076,0.0334309,0.245581}
,{0.237351,-0.016746,-0.252916,-0.218325,0.0499938,0.264792,0.196116,-0.0825125,-0.272807,-0.171047,0.113828,0.276844,0.143484,-0.143484,-0.276844,-0.113828,0.171047,0.272807,0.0825125,-0.196116,-0.264792,-0.0499938,0.218325,0.252916,0.016746,-0.237351}
,{0.228255,-0.0663742,-0.275328,-0.128891,0.183917,0.259327,-1.61425e-016,-0.259327,-0.183917,0.128891,0.275328,0.0663742,-0.228255,-0.228255,0.0663742,0.275328,0.128891,-0.183917,-0.259327,2.37939e-016,0.259327,0.183917,-0.128891,-0.275328,-0.0663742,0.228255}
,{0.218325,-0.113828,-0.272807,-0.016746,0.264792,0.143484,-0.196116,-0.237351,0.0825125,0.276844,0.0499938,-0.252916,-0.171047,0.171047,0.252916,-0.0499938,-0.276844,-0.0825125,0.237351,0.196116,-0.143484,-0.264792,0.016746,0.272807,0.113828,-0.218325}
,{0.2076,-0.157553,-0.245581,0.0983497,0.269291,-0.0334309,-0.27735,-0.0334309,0.269291,0.0983497,-0.245581,-0.157553,0.2076,0.2076,-0.157553,-0.245581,0.0983497,0.269291,-0.0334309,-0.27735,-0.0334309,0.269291,0.0983497,-0.245581,-0.157553,0.2076}
};

#define M_PI 3.14159265358979323846

static float blaBloqueActual[BLA_LARGOVENTANA];

/*Remueve el valor de continua del bloque actual*/
static void blaRemoverContinua(void){
	float promedio = 0;
	int i;
	for(i=0;i<BLA_LARGOVENTANA;i++)
		promedio += blaBloqueActual[i];
		
	/*Calculo el valor medio de la señal*/
	promedio /= (float)BLA_LARGOVENTANA;
	
	/*Se lo resto a cada una de los elementos del bloque*/
	for(i=0;i<BLA_LARGOVENTANA;i++)
		blaBloqueActual[i] -= promedio;
}

/*Realiza un prefiltrado pasaaltos, de transferencia H(z) = 1-0.97z^-1 */
static void blaPreenfasis(void){
	int i;
	/*Filtro desde el final al principio, para no sobreescribir
	  los valores que todavía no fueron procesados*/
	for(i=BLA_LARGOVENTANA;i>=1;i--)
		blaBloqueActual[i] = blaBloqueActual[i] - 0.97*blaBloqueActual[i-1];
	
	/*El primer bloque se filtra de forma distinta
	  fue implementado solamente de esta forma para que los 
	  coeficientes den lo más parecido posible a los calculados con el HTK*/
	blaBloqueActual[0] = blaBloqueActual[0] * (1.0-0.97);
}

/*Multiplica el bloque actual por una ventana de Hamming*/
static void blaBloqueHamming(void){
	int i;
	
	for(i=0;i<BLA_LARGOVENTANA;i++){
		#if 0
			/* Removido por ser muy ineficiente (calcula muchas veces los mismos numeros) */
			float arg = 2.0f*M_PI*i/(BLA_LARGOVENTANA-1);
			float coef = 0.54f-0.46f*cos(arg);
		#endif
		/* multiplico el coeficiente correspondiente con la muestra */
		blaBloqueActual[i] *= blaHamming[i];
	}
		
}

/*Calcula los BLA_NUMCEPS+1 coeficientes cepstrales en las frecuencias Mel del bloque actual
  Inspirado en la función Wave2FBank de HSigP.c (del toolkit HTK)
  Resumiendo, realiza los siguientes pasos:
  	- Realiza FFT al bloque, lo que requiere agregar ceros hasta llegar a la próxima potencia de dos
  	- Calcula módulo al cuadrado de cada elemento de la FFT (por la simetría, no hacen falta todos los elementos)
  	- Aplica el banco de filtros triangulares y suma las energías de cada banco, es decir, es un binning con coeficientes triangulares
  	- Toma logaritmo a la energía que se obtuvo de cada uno de los filtros, teniendo en cuenta que puede llegar a dar -inf
  	- Aplicar transformada coseno discreta a los valores obtenidos
  	- Realiza un "liftrado", multiplica los coeficientes por ciertos valores, para incrementar la SNR */
static void blaBloqueMFCC(float *vecMFCC){
	/*Cálculo de FFT (real) de cada bloque*/
	arm_rfft_fast_instance_f32 S;
	arm_rfft_fast_init_f32(&S, 512);
	
	/*Zero-padding 400->512*/
	float entrada[512];
	int i;
	for(i=0;i<BLA_LARGOVENTANA;i++){
		entrada[i] = blaBloqueActual[i];
	}
	for(i=BLA_LARGOVENTANA;i<512;i++)
		entrada[i] = 0.0f;
	
	float salida[512] = {0};

	/*FFT real con salida compleja*/
	arm_rfft_fast_f32(&S, entrada, salida, 0);	

	/*La biblioteca en el elemento cero pone a X[0] + j X[N/2]
	  (por las propiedades de la FFT con datos reales)
	  por lo que seteo a 0 la parte imaginaria del primer elemento*/
	salida[1] = 0.0f;
		
	/*Obtener magnitud de cada elemento
	  correspondiente a USEPOWER=TRUE del HTK*/
	float salidaMag[256] = {0};
	arm_cmplx_mag_squared_f32(salida, salidaMag, 256);

	/*Filtrado triangular*/
	float amplitudLogFiltro[BLA_NUMCHANS];
	int j;
	for(j=0;j<BLA_NUMCHANS;j++)
		amplitudLogFiltro[j] = 0.0f;
	float coefCero = 0.0f;
	
	for(j=0;j<256;j++){
		int bin = blaBancoFiltrosIdx[j];
		float t1 = blaBancoFiltrosPesos[j]*salidaMag[j];
    
		if(bin>0)
			amplitudLogFiltro[bin-1] += t1;
		
		if(bin<BLA_NUMCHANS && bin>-1)
			amplitudLogFiltro[bin] += salidaMag[j]-t1;    
	}
	
	for(j=0;j<BLA_NUMCHANS;j++){
		const float melfloor = 1.0;
		
		if(amplitudLogFiltro[j]<melfloor){
			/*Para evitar problemas numéricos si es demasiado chico el resultado del binning 
			  por ejemplo si hay sectores con 'ceros', sin ruido alguno*/
			amplitudLogFiltro[j] = log(melfloor);
		}else{
			amplitudLogFiltro[j] = log(amplitudLogFiltro[j]);
		}
		coefCero += sqrtf(2.0f/BLA_NUMCHANS) * amplitudLogFiltro[j];
	}
	
	/*Calculo Transformada Coseno Discreta (DCT)
	  Es la DCT tipo 2, no tiene una función dedicada en CMSIS-DSP
	  se podría implementar con una FFT, pero para este tamaño
	  /26*13 puede que no sea mucho más rápida*/
	
	for(i=0;i<BLA_NUMCEPS;i++){
		float suma = 0.0f;
		
		for(j=0;j<BLA_NUMCHANS;j++){
			#if 0
			/*El +0.5f originalmente era -0.5f, 
			  debido a que los indices van desde 0 a BLA_NUMCHANS-1, es necesario sumarle 1 al calculo de la DCT*/
			suma += amplitudLogFiltro[j] * cos(M_PI*(float)(i+1)/BLA_NUMCHANS * ((float)j+0.5f));
			#endif
			
			/*Calculos reemplazados por tabla*/
			suma += amplitudLogFiltro[j] * blaDCT[i][j];
		}
		
		vecMFCC[i] =/*sqrt(2.0f/BLA_NUMCHANS) * */suma;
	}
	/*Liftering, escala los coeficientes de mayor orden para que tengan amplitudes similares
	  /Ver "5.6 Cepstral Features" en HTK Book  */
	for(i=0;i<BLA_NUMCEPS;i++){
		vecMFCC[i] *= (1.0f+(float)BLA_CEPLIFTER/2.0f * sinf(M_PI*(i+1)/(float)BLA_CEPLIFTER));
	}
	
	/*Agrego el coeficiente 0*/
	vecMFCC[BLA_NUMCEPS] = coefCero;
	
}

int blaObtenerCoeficientes(const int16_t *buffer, float *vecMFCC){
	/*Cargo el bloque correspondiente en el vector de floats*/
	int i;	
	for(i=0;i<BLA_LARGOVENTANA;i++){
		/*Escalo las muestras para que estén en el rango (-32k;32k) 
		  De esta forma todos los coeficientes quedan similares a los que 
		  calcula el toolkit HTK con la herramienta HCopy*/
		blaBloqueActual[i] = (buffer[i]/(float)BLA_ADC_RANGO)*32768.0f;
	}

	/*Remuevo un posible offset de continua*/
	/*TODO: En teoría esta operación tendría que hacerse con todo el buffer
	  pero no parece cambiar mucho*/
	blaRemoverContinua();
	
	/*Preénfasis, filtrado pasa altos del bloque*/
	blaPreenfasis();

	/*Aplicado de ventaneo tipo Hamming al bloque*/
	blaBloqueHamming();

	/*Calculo los coeficientes MFCC*/
	blaBloqueMFCC(vecMFCC);

	return 0;
}
